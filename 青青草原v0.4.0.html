

<!DOCTYPE html>
<html>
<head>
    <title>ç”Ÿæ€æ¨¡æ‹Ÿå™¨</title>
    <!-- å¼•å…¥Chart.jså›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* ä¼˜åŒ–è‡ªç„¶ç”Ÿæ€ä¸»é¢˜ */
            --primary-color: #ffffff;  /* æå‡ç¾Šçš„æ˜åº¦ï¼ˆLä»85â†’93ï¼‰ */
            --secondary-color: #ff0000;  /* å¢åŠ ç‹¼çš„é¥±å’Œåº¦ï¼ˆSä»30â†’45ï¼‰ */
            --bg-color: #000000;       /* ä¿æŒæ·±æµ·è“ */
            --text-color: #ffffff;     /* æé«˜æ–‡å­—å¯¹æ¯”åº¦ */
            --grass-color: #00ff80;    /* å¾®è°ƒè‰åœ°æ˜åº¦ */
            --button-color: #008c15;   /* æ–°å¢æŒ‰é’®é¢œè‰²å˜é‡ */
        }

        [data-theme="dark"] {
            /* é‡æ„æš—å¤œä¸»é¢˜ */
            --primary-color: #FFE082;  /* ç¾Šçš„é¢œè‰²æ”¹ä¸ºç¥ç€è‰² */
            --secondary-color: #D4A5E9;  /* ç‹¼çš„é¢œè‰²æ”¹ä¸ºå“çº¢æ–¹å‘çš„é¢œè‰² */
            --bg-color: #0c0217;       /* åŠ æ·±èƒŒæ™¯æ˜åº¦ï¼ˆLä»15â†’10ï¼‰ */
            --text-color: #fff8c1;     /* æé«˜æ–‡å­—äº®åº¦ */
            --grass-color: hsl(74, 84%, 61%);    /* å¢åŠ è‰åœ°ç°åº¦ */
            --button-color: rgb(111, 58, 118);   /* ä¿®æ”¹æŒ‰é’®é¢œè‰² */
        }

        [data-theme="tech"] {
            /* èµ›åšéœ“è™¹ä¸»é¢˜ */
            --primary-color: #00F3FF;  /* éœ“è™¹è“ï¼ˆç¾Šï¼‰ */
            --secondary-color: #FF2079;  /* è§å…‰ç²‰ï¼ˆç‹¼ï¼‰ */
            --bg-color: #0A0F1F;       /* æ·±ç©ºé»‘ */
            --text-color: #2bffca;     /* å†°è“è‰² */
            --grass-color: #00C16E;    /* ç”µå­ç»¿ */
            --button-color: #1f94dd;   /* ä¿®æ”¹æŒ‰é’®é¢œè‰² */
        }

        [data-theme="warm"] {
            /* å¼ºåŒ–ç§‹æ—¥ä¸»é¢˜ */
            --primary-color: #e5d79c;  /* æ”¹ä¸ºæ©™è‰²è°ƒå¢åŠ æ´»åŠ› */
            --secondary-color: #a63a24;  /* åŠ æ·±çº¢æ£•è‰²æ˜åº¦ï¼ˆLä»35â†’25ï¼‰ */
            --bg-color: #1a1a00;       /* ä¿®æ”¹ä¸ºä¸é€æ˜ç‰ˆæœ¬ */
            --text-color: #f7ce8c;     /* å¢åŠ æ–‡å­—å¯¹æ¯” */
            --grass-color: #bcdb35;    /* è°ƒæ•´è‰åœ°é¥±å’Œåº¦ */
            --button-color: #aa7d50;   /* ä¿®æ”¹æŒ‰é’®é¢œè‰² */
        }

        /* æ·»åŠ æ¸å˜è¿‡æ¸¡æ•ˆæœ */
        [data-theme] {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ä¸ºç§‘æŠ€ä¸»é¢˜æ·»åŠ å‘å…‰æ•ˆæœ */
        [data-theme="tech"] button {
            box-shadow: 0 0 8px var(--primary-color);
            text-shadow: 0 0 5px rgba(255,255,255,0.3);
        }

        /* ç§‹æ—¥ä¸»é¢˜æ·»åŠ çº¹ç†èƒŒæ™¯ */
        [data-theme="warm"] body {
            background-color: var(--bg-color); /* å…³é”®ä¿®æ­£ */
        }

        /* åŸºç¡€é¡µé¢æ ·å¼ */
        body {
            margin: 0;
            overflow: hidden;  /* éšè—æ»šåŠ¨æ¡ä¿æŒå…¨å±ä½“éªŒ */
            font-family: Arial, sans-serif;
            background: var(--bg-color);
        }

        /* ä¸»æ¸¸æˆç”»å¸ƒæ ·å¼ */
        #gameCanvas {
            width: 100vw;     /* å æ»¡æ•´ä¸ªè§†å£å®½åº¦ */
            height: 100vh;    /* å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
            display: block;
            background: var(--bg-color);
        }

        /* æ§åˆ¶æŒ‰é’®å®¹å™¨æ ·å¼ */
        .controls {
            position: fixed;
            left: 20px;
            top: 20px;
            z-index: 1000;    /* ç¡®ä¿æŒ‰é’®åœ¨æœ€é¡¶å±‚ */
            background: var(--ui-bg);
            padding: 10px;
            border-radius: 8px;
            color: var(--text-color);
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        button {
            padding: 8px 15px;
            margin: 3px;
            cursor: pointer;
            background: linear-gradient(145deg, var(--button-color) 0%, color-mix(in srgb, var(--button-color), black 15%) 100%);
            color: white;
            border: none;
            border-radius: 4px;
            transition: all 0.3s;  /* æ‰€æœ‰å±æ€§è¿‡æ¸¡åŠ¨ç”» */
        }
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        button:hover {
            opacity: 0.8;
            transform: scale(1.05);  /* è½»å¾®æ”¾å¤§æ•ˆæœ */
        }

        /* å‚æ•°é¢æ¿æ ·å¼ */
        .param-panel {
            position: fixed;
            right: -340px;     /* åˆå§‹éšè—åœ¨å³ä¾§å¤– */
            top: 60px;
            background: rgba(0,0,0,0.1);  /* ä¿®æ”¹èƒŒæ™¯é€æ˜åº¦ä¸º10% */
            padding: 15px;
            color: var(--text-color);
            width: 320px;
            max-height: 90vh;  /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            overflow-y: auto;  /* å†…å®¹è¿‡å¤šæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            transition: right 0.3s;  /* æ»‘åŠ¨åŠ¨ç”»æ•ˆæœ */
        }
        /* æ¿€æ´»çŠ¶æ€çš„å‚æ•°é¢æ¿ */
        .param-panel.active {
            right: 20px;  /* æ»‘åŠ¨åˆ°å¯è§ä½ç½® */
        }

        /* ç»Ÿè®¡å›¾è¡¨å®¹å™¨ */
        #chartContainer {
            position: fixed;
            left: -420px;      /* åˆå§‹éšè—åœ¨å·¦ä¾§å¤– */
            bottom: 20px;
            background: rgba(0,0,0,0.1);  /* ä¸é€æ˜åº¦è°ƒæ•´ä¸º10% */
            border-radius: 8px;
            padding: 15px;
            color: var(--text-color);
            width: 400px;
            height: 250px;
            transition: all 0.3s; /* ç®€åŒ–ä¸ºç»Ÿä¸€è¿‡æ¸¡æ•ˆæœ */
            overflow: hidden; /* éšè—æº¢å‡ºçš„æŒ‰é’® */
        }
        /* ä¿®æ”¹æ¿€æ´»çŠ¶æ€æ ·å¼ */
        #chartContainer.active {
            left: 20px !important;
            transition: all 0.3s;
        }

        /* è¦†ç›–å±•å¼€çŠ¶æ€æ ·å¼ */
        #chartContainer.expanded {
            left: 0 !important;
            bottom: 0 !important;
            width: 98% !important;
            z-index: 1002;
        }

        /* å‚æ•°é¡¹æ ·å¼ */
        .param-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);  /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            border-radius: 4px;
        }
        /* å‚æ•°æ ‡ç­¾æ ·å¼ */
        .param-item label {
            display: inline-block;
            width: 120px;  /* ç¼©å°æ ‡ç­¾å®½åº¦ */
        }
        /* æ»‘åŠ¨æ¡æ ·å¼ */
        input[type="range"] {
            width: 140px;
            height: 3px;
            background: #666;
            margin: 5px 0;
        }

        /* æ•°å­—è¾“å…¥æ¡†æ ·å¼ */
        .number-input {
            width: 60px;
            height: 24px;
            margin-left: 8px;
            padding: 2px 5px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 3px;
            color: var(--text-color);
            font-size: 0.9em;
        }

        /* æ–°å¢æŒ‰é’®æ ·å¼ */
        .expand-btn {
            position: relative; /* ç§»é™¤absoluteå®šä½ */
            margin-left: 5px; /* æ·»åŠ é—´è· */
            right: 10px;
            top: 10px;
            padding: 4px 8px;
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
        }

        /* ä¸»é¢˜åˆ‡æ¢å™¨æ ·å¼ */
        .theme-switcher {
            position: fixed;
            right: 20px;
            top: 20px;
            display: flex;
            gap: 8px;
            z-index: 1001;
        }

        .theme-switcher button {
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--text-color);
            transition: all 0.3s;
        }

        .theme-switcher button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px var(--primary-color);
        }

        /* å¢åŠ ç”Ÿç‰©è½®å»“æå‡è¾¨è¯†åº¦ */
        .Animal::after {
            content: '';
            position: absolute;
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            border: 2px solid rgba(0,0,0,0.15);
            border-radius: 50%;
        }

        /* åŠ¨æ€æŠ•å½±å¢å¼ºå±‚æ¬¡ */
        [data-theme="dark"] .Animal {
            filter: drop-shadow(0 2px 4px rgba(255,255,255,0.1));
        }

        [data-theme="warm"] .Animal {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        /* æŠ˜å ç»„æ ·å¼ */
        .param-group {
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden; /* æ–°å¢ */
        }

        /* ç»„æ ‡é¢˜æ ·å¼ */
        .group-header {
            padding: 8px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* æŠ˜å å†…å®¹å®¹å™¨ */
        .group-content {
            max-height: 0;
            overflow: hidden; /* æ·»åŠ  */
            padding: 0 5px; /* è°ƒæ•´å·¦å³å†…è¾¹è· */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* æ”¹ä¸ºallè¿‡æ¸¡ */
        }

        /* æŠ˜å æŒ‰é’®æ ·å¼ */
        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 0;
            transition: transform 0.3s;
        }

        /* å±•å¼€çŠ¶æ€æ—‹è½¬æŒ‰é’® */
        .expanded .toggle-btn {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
    <div class="controls">
        <button onclick="spawn('grass', 100)">+100è‰</button>
        <button onclick="spawn('sheep', 3)">+3ç¾Š</button>
        <button onclick="spawn('wolf', 1)">+1ç‹¼</button>
        <button onclick="resetWorld()">é‡ç½®ä¸–ç•Œ</button>
        <button onclick="togglePanel()">å‚æ•°é¢æ¿</button>
        <button onclick="toggleChart()">ç»Ÿè®¡å›¾è¡¨</button>
        <button onclick="clearEntities()">åˆ é™¤æ‰€æœ‰ç”Ÿç‰©</button> <!-- æ–°å¢æŒ‰é’® -->
        <button onclick="toggleEnergyBars()">éšè—èƒ½é‡æ¡</button> <!-- æ–°å¢æŒ‰é’® -->
        <div class="theme-switcher">
            <button onclick="changeTheme('default')">ğŸŒ¿ è‡ªç„¶</button>
            <button onclick="changeTheme('dark')">ğŸŒ‘ æ˜Ÿäº‘</button>
            <button onclick="changeTheme('tech')">ğŸ”µ ç§‘æŠ€</button>
            <button onclick="changeTheme('warm')">ğŸŸ  æš–ç§‹</button>
        </div>
    </div>

    <!-- ä¸»æ¸¸æˆç”»å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- å‚æ•°è°ƒèŠ‚é¢æ¿ -->
    <div class="param-panel">
        <h3 style="margin-top:0; color: var(--primary-color);">ç”Ÿæ€ç³»ç»Ÿå‚æ•°</h3>
        
        <!-- è‰ç”Ÿé•¿ç‡å‚æ•° -->
        <div class="param-item">
            <label>ğŸŒ± è‰ç”Ÿé•¿ç‡ (0-15):</label>
            <input type="range" id="grassRate" min="0" max="1" step="0.1" value="0.2">
            <input type="number" class="number-input" value="0.2">
            <span id="grassRateValue">0.2</span>
        </div>

        <!-- ç¾Šå‚æ•°åˆ†ç»„ -->
        <div class="param-group">
            <div class="group-header" onclick="toggleGroup('sheep')">
                ğŸ‘ ç¾Šå‚æ•°
                <button class="toggle-btn">â–¼</button>
            </div>
            <div class="group-content" id="sheepGroup" style="max-height: 0px;"> 
                <!-- åŸæœ‰ç¾Šå‚æ•°é¡¹ -->
                <div class="param-item">
                    <label>ğŸ‘ ç§»åŠ¨é€Ÿåº¦ (0.2-5):</label>
                    <input type="range" id="sheepSpeed" min="0.2" max="5" step="0.2" value="1">
                    <input type="number" class="number-input" value="1">
                    <span id="sheepSpeedValue">1</span>
                </div>

                <div class="param-item">
                    <label>ğŸ‘ ç¹æ®–é˜ˆå€¼ (10-450):</label>
                    <input type="range" id="sheepBreed" min="10" max="150" step="5" value="50">
                    <input type="number" class="number-input" value="50">
                    <span id="sheepBreedValue">50</span>
                </div>

                <div class="param-item">
                    <label>ğŸ‘ èƒ½é‡æ¶ˆè€— (0.5-5):</label>
                    <input type="range" id="sheepLoss" min="0.5" max="5" step="0.5" value="1.5">
                    <input type="number" class="number-input" value="1.5">
                    <span id="sheepLossValue">1.5</span>
                </div>

                <div class="param-item">
                    <label>ğŸ‘ æ„ŸçŸ¥èŒƒå›´ (50-500):</label>
                    <input type="range" id="sheepPerception" min="50" max="500" step="10" value="100">
                    <input type="number" class="number-input" value="100">
                    <span id="sheepPerceptionValue">100</span>
                </div>
            </div>
        </div>

        <!-- ç‹¼å‚æ•°åˆ†ç»„ -->
        <div class="param-group">
            <div class="group-header" onclick="toggleGroup('wolf')">
                ğŸº ç‹¼å‚æ•°
                <button class="toggle-btn">â–¼</button>
            </div>
            <div class="group-content" id="wolfGroup" style="max-height: 0px;"> 
                <!-- åŸæœ‰ç‹¼å‚æ•°é¡¹ -->
                <div class="param-item">
                    <label>ğŸº ç§»åŠ¨é€Ÿåº¦ (0.2-5):</label>
                    <input type="range" id="wolfSpeed" min="0.5" max="5" step="0.1" value="1.5">
                    <input type="number" class="number-input" value="1.5">
                    <span id="wolfSpeedValue">1.5</span>
                </div>

                <div class="param-item">
                    <label>ğŸº ç¹æ®–é˜ˆå€¼ (10-150):</label>
                    <input type="range" id="wolfBreed" min="10" max="150" step="5" value="50">
                    <input type="number" class="number-input" value="50">
                    <span id="wolfBreedValue">50</span>
                </div>

                <div class="param-item">
                    <label>ğŸº èƒ½é‡æ¶ˆè€— (0.5-5):</label>
                    <input type="range" id="wolfLoss" min="0.5" max="5" step="0.5" value="2">
                    <input type="number" class="number-input" value="2">
                    <span id="wolfLossValue">2</span>
                </div>

                <div class="param-item">
                    <label>ğŸº æ„ŸçŸ¥èŒƒå›´ (50-500):</label>
                    <input type="range" id="wolfPerception" min="50" max="500" step="10" value="150">
                    <input type="number" class="number-input" value="150">
                    <span id="wolfPerceptionValue">150</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å›¾è¡¨å®¹å™¨ -->
    <div id="chartContainer">
        <div style="position: absolute; right: 10px; top: 10px; display: flex; gap: 5px;">
            <button class="expand-btn" onclick="toggleExpand()">å±•å¼€</button>
            <button class="expand-btn" onclick="clearChartData()">æ¸…é™¤æ•°æ®</button>
        </div>
        <canvas id="populationChart"></canvas>
    </div>

    <script>
        // è·å–ç”»å¸ƒå…ƒç´ å’Œ2Dæ¸²æŸ“ä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // å®ä½“å­˜å‚¨å¯¹è±¡ï¼šåŒ…å«è‰ã€ç¾Šã€ç‹¼çš„æ•°ç»„
        let entities = { grass: [], sheep: [], wolf: [] };
        
        // å›¾è¡¨æ•°æ®å­˜å‚¨ï¼šæ—¶é—´æ ‡ç­¾å’Œç§ç¾¤æ•°é‡
        let chartData = { labels: [], sheep: [], wolf: [] };

        // ç”»å¸ƒå°ºå¯¸è°ƒæ•´å‡½æ•°
        function resizeCanvas() {
            canvas.width = window.innerWidth;   // é€‚é…çª—å£å®½åº¦
            canvas.height = window.innerHeight; // é€‚é…çª—å£é«˜åº¦
        }
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸

        // åŠ¨æ€é…ç½®å¯¹è±¡ï¼ˆå®æ—¶è¯»å–æ»‘åŠ¨æ¡å€¼ï¼‰
        const config = {
            grass: {
                get spawnRate() { 
                    return parseFloat(document.querySelector('#grassRate + input[type="number"]').value); 
                },
                maxCount: 20000
            },
            sheep: {
                get moveSpeed() { 
                    return parseFloat(document.querySelector('#sheepSpeed + input[type="number"]').value); 
                },
                eatDistance: 5,
                energy: {
                    gain: 10,
                    get loss() { return parseFloat(document.querySelector('#sheepLoss + input[type="number"]').value); },
                    get breed() { return parseFloat(document.querySelector('#sheepBreed + input[type="number"]').value); }
                },
                get perceptionRange() { return parseFloat(document.querySelector('#sheepPerception + input[type="number"]').value); }
            },
            wolf: {
                get moveSpeed() { 
                    return parseFloat(document.querySelector('#wolfSpeed + input[type="number"]').value); 
                },
                eatDistance: 8,
                energy: {
                    gain: 10,
                    get loss() { return parseFloat(document.querySelector('#wolfLoss + input[type="number"]').value); },
                    get breed() { return parseFloat(document.querySelector('#wolfBreed + input[type="number"]').value); }
                },
                get perceptionRange() { return parseFloat(document.querySelector('#wolfPerception + input[type="number"]').value); }
            }
        };

        // é¢œè‰²è½¬æ¢å·¥å…·å‡½æ•°
        function hexToRgb(hex) {
            if (!hex || hex === 'transparent') return [255, 255, 255];
            hex = hex.replace('#','');
            const bigint = parseInt(hex, 16);
            return [
                (bigint >> 16) & 255,
                (bigint >> 8) & 255,
                bigint & 255
            ];
        }

        function getThemeColor(varName) {
            const hex = getComputedStyle(document.documentElement)
                .getPropertyValue(varName).trim();
            return hexToRgb(hex);
        }

        // åŠ¨ç‰©ç±»å®šä¹‰
        class Animal {
            constructor(type, x, y) {
                this.type = type;      // å®ä½“ç±»å‹ï¼š'sheep'æˆ–'wolf'
                this.x = x;           // Xåæ ‡
                this.y = y;           // Yåæ ‡
                this.energy = config[type].energy.breed * 0.5; // åˆå§‹èƒ½é‡ä¸ºç¹æ®–é˜ˆå€¼çš„50%
                this.size = type === 'sheep' ? 4 : 6; // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒå¤§å°
                this.walkAngle = Math.random() * Math.PI * 2; // éšæœºåˆå§‹ç§»åŠ¨æ–¹å‘
                // æ–°å¢é€ƒè·‘çŠ¶æ€æ ‡è®°å’Œé€ƒè·‘å‰©ä½™æ—¶é—´
                this.isFleeing = false;
                this.fleeDuration = 0;
            }

            // ç¯é¢æ‹“æ‰‘è·ç¦»è®¡ç®—æ–¹æ³•
            getWrappedPosition(target) {
                // è®¡ç®—æ‰€æœ‰å¯èƒ½çš„é•œåƒä½ç½®ï¼ˆåŒ…å«æ­£å¸¸ä½ç½®å’Œä¸‰ä¸ªç¯é¢é•œåƒï¼‰
                const mirrors = [
                    { x: target.x, y: target.y }, // åŸå§‹ä½ç½®
                    { x: target.x - canvas.width, y: target.y }, // å·¦ä¾§é•œåƒ
                    { x: target.x + canvas.width, y: target.y }, // å³ä¾§é•œåƒ
                    { x: target.x, y: target.y - canvas.height }, // ä¸Šæ–¹é•œåƒ
                    { x: target.x, y: target.y + canvas.height }  // ä¸‹æ–¹é•œåƒ
                ];

                // å¯»æ‰¾æœ€è¿‘çš„æœ‰æ•ˆä½ç½®
                let closest = { x: target.x, y: target.y };
                let minDist = Infinity;
                
                mirrors.forEach(mirror => {
                    const dx = mirror.x - this.x;
                    const dy = mirror.y - this.y;
                    const dist = dx * dx + dy * dy; // ä½¿ç”¨å¹³æ–¹è·ç¦»æ¯”è¾ƒé¿å…å¼€æ–¹è¿ç®—
                    if (dist < minDist) {
                        minDist = dist;
                        closest = mirror;
                    }
                });

                return closest;
            }

            // ç§»åŠ¨æ–¹æ³•
            move() {
                const targets = this.type === 'sheep' ? entities.grass : entities.sheep;
                let closest = null, closestDist = Infinity;

                // å¯»æ‰¾æœ€è¿‘çš„ç›®æ ‡ï¼ˆæ›¿æ¢åŸæ¥çš„forå¾ªç¯ï¼‰
                for (const target of targets) {
                    // è·å–ç¯é¢æ‹“æ‰‘ä¸‹çš„æœ€è¿‘é•œåƒä½ç½®
                    const wrappedTarget = this.getWrappedPosition(target);
                    const dx = wrappedTarget.x - this.x;
                    const dy = wrappedTarget.y - this.y;
                    const dist = Math.hypot(dx, dy);
                    
                    if (dist < closestDist) {
                        closest = wrappedTarget; // å­˜å‚¨ä¿®æ­£åçš„ä½ç½®
                        closestDist = dist;
                        closest.original = target; // ä¿ç•™åŸå§‹ç›®æ ‡å¼•ç”¨ç”¨äºåç»­æ“ä½œ
                    }
                }

                // æ·»åŠ ç¾Šçœ‹åˆ°ç‹¼é€ƒè·‘çš„é€»è¾‘
                if (this.type === 'sheep') {
                    let closestWolf = null;
                    let closestWolfDist = Infinity;

                    for (const wolf of entities.wolf) {
                        // è·å–ç¯é¢æ‹“æ‰‘ä¸‹çš„æœ€è¿‘é•œåƒä½ç½®
                        const wrappedWolf = this.getWrappedPosition(wolf);
                        const dx = wrappedWolf.x - this.x;
                        const dy = wrappedWolf.y - this.y;
                        const dist = Math.hypot(dx, dy);
                        
                        if (dist < closestWolfDist) {
                            closestWolf = wrappedWolf; // å­˜å‚¨ä¿®æ­£åçš„ä½ç½®
                            closestWolfDist = dist;
                            closestWolf.original = wolf; // ä¿ç•™åŸå§‹ç›®æ ‡å¼•ç”¨ç”¨äºåç»­æ“ä½œ
                        }
                    }

                    // å¦‚æœå‘ç°ç‹¼ä¸”è·ç¦»å°äºæ„ŸçŸ¥èŒƒå›´ï¼Œåˆ™é€ƒè·‘
                    if (closestWolf && closestWolfDist < config[this.type].perceptionRange) {
                        this.isFleeing = true;
                        this.fleeDuration = 30; // è®¾ç½®30å¸§çš„é€ƒè·‘æŒç»­æ—¶é—´
                        
                        // é€ƒè·‘æ–¹å‘è®¡ç®—ï¼ˆå¢åŠ éšæœºåç§»é¿å…ç›´çº¿é€ƒè·‘ï¼‰
                        const angle = Math.atan2(this.y - closestWolf.y, this.x - closestWolf.x) 
                                    + (Math.random()-0.5)*0.5; // Â±15åº¦éšæœºåç§»
                        
                        // ä½¿ç”¨åŸæ¥çš„ç§»åŠ¨é€Ÿåº¦
                        this.x += Math.cos(angle) * config[this.type].moveSpeed;
                        this.y += Math.sin(angle) * config[this.type].moveSpeed;
                        
                        // è·³è¿‡è‰è¿½è¸ªé€»è¾‘ï¼ˆæ–°å¢æ¡ä»¶åˆ¤æ–­ï¼‰
                        return; // ç›´æ¥ç»“æŸmoveæ–¹æ³•æ‰§è¡Œ
                    } else if (this.fleeDuration > 0) {
                        this.fleeDuration--;
                    } else {
                        this.isFleeing = false;
                    }
                }

                // ç›®æ ‡è¿½è¸ªé€»è¾‘ï¼ˆæ›¿æ¢åŸæ¥çš„è§’åº¦è®¡ç®—ï¼‰
                if (closest && closestDist < config[this.type].perceptionRange) {
                    const angle = Math.atan2(closest.y - this.y, closest.x - this.x);
                    this.x += Math.cos(angle) * config[this.type].moveSpeed;
                    this.y += Math.sin(angle) * config[this.type].moveSpeed;
                } else {
                    // éšæœºæ¸¸èµ°é€»è¾‘ï¼š2%æ¦‚ç‡æ”¹å˜æ–¹å‘
                    if (Math.random() < 0.02) {
                        this.walkAngle += (Math.random() - 0.5) * Math.PI; // Â±90åº¦éšæœºåç§»
                    }
                    this.x += Math.cos(this.walkAngle) * config[this.type].moveSpeed;
                    this.y += Math.sin(this.walkAngle) * config[this.type].moveSpeed;
                }

                // æ·»åŠ æ–¥åŠ›é€»è¾‘ï¼šé¿å…åŠ¨ç‰©é‡å 
                const repulsionRadius = 15; // é€ƒè·‘æ—¶å‡å°æ–¥åŠ›åŠå¾„
                const repulsionStrength = 0.3; // é€ƒè·‘æ—¶é™ä½æ–¥åŠ›å¼ºåº¦

                for (const other of entities[this.type]) {
                    if (other !== this) {
                        const dx = other.x - this.x;
                        const dy = other.y - this.y;
                        const dist = Math.hypot(dx, dy);

                        if (dist < repulsionRadius) {
                            const angle = Math.atan2(dy, dx);
                            const repulsionForce = repulsionStrength * Math.pow(
                                (repulsionRadius - dist)/repulsionRadius, 
                                1.2 // ä½¿ç”¨æ›´å¹³ç¼“çš„æ›²çº¿
                            );
                            this.x -= Math.cos(angle) * repulsionForce;
                            this.y -= Math.sin(angle) * repulsionForce;
                        }
                    }
                }

                // ç¡®ä¿å®ä½“åæ ‡åœ¨ç”»å¸ƒèŒƒå›´å†…
                this.x = (this.x + canvas.width) % canvas.width;
                this.y = (this.y + canvas.height) % canvas.height;
            }

            // æ›´æ–°çŠ¶æ€ï¼ˆè¿”å›æ˜¯å¦å­˜æ´»ï¼‰
            update() {
                this.move();

                const targets = this.type === 'sheep' ? entities.grass : entities.sheep;
                // é€†å‘éå†ä»¥ä¾¿å®‰å…¨åˆ é™¤å…ƒç´ 
                for (let i = targets.length - 1; i >= 0; i--) {
                    const target = targets[i];
                    // è·å–ç¯é¢æ‹“æ‰‘ä¸‹çš„æœ€è¿‘é•œåƒä½ç½®
                    const wrappedTarget = this.getWrappedPosition(target);
                    // è¿›é£Ÿæ£€æµ‹ï¼šè·ç¦»å°äºeatDistanceæ—¶è¿›é£Ÿ
                    if (Math.hypot(wrappedTarget.x - this.x, wrappedTarget.y - this.y) < config[this.type].eatDistance) {
                        this.energy += config[this.type].energy.gain; // å¢åŠ èƒ½é‡
                        targets.splice(i, 1); // ç§»é™¤è¢«åƒçš„ç›®æ ‡
                        break; // æ¯æ¬¡åªåƒä¸€ä¸ªç›®æ ‡
                    }
                }

                // ç¹æ®–æ£€æµ‹ï¼šèƒ½é‡è¾¾åˆ°é˜ˆå€¼æ—¶åˆ†è£‚
                if (this.energy >= config[this.type].energy.breed) {
                    const newEnergy = config[this.type].energy.breed * 0.5; // æ–°ç”Ÿæˆç”Ÿç‰©çš„èƒ½é‡ä¸ºç¹æ®–é˜ˆå€¼çš„50%
                    entities[this.type].push(new Animal(this.type, this.x, this.y)); // ç”Ÿæˆæ–°ä¸ªä½“
                    entities[this.type][entities[this.type].length - 1].energy = newEnergy; // è®¾ç½®æ–°ä¸ªä½“çš„èƒ½é‡
                    this.energy -= newEnergy; // å‡å°‘å½“å‰ç”Ÿç‰©çš„èƒ½é‡
                }

                // èƒ½é‡æ¶ˆè€—æ£€æµ‹
                if (Math.random() < 1/6) {
                    this.energy -= config[this.type].energy.loss / 10;
                }

                return this.energy > 0; // è¿”å›å­˜æ´»çŠ¶æ€
            }

            // ç»˜åˆ¶æ–¹æ³•
            draw() {
                // ç¡®ä¿å®ä½“åæ ‡åœ¨ç”»å¸ƒèŒƒå›´å†…
                const drawX = (this.x + canvas.width) % canvas.width;
                const drawY = (this.y + canvas.height) % canvas.height;

                // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²ï¼ˆç¾Šç™½/ç‹¼äº®çº¢è‰²ï¼‰
                const colors = this.type === 'sheep' ? 
                    getThemeColor('--primary-color') :
                    getThemeColor('--secondary-color');
                const energyRatio = this.energy / config[this.type].energy.breed; // èƒ½é‡æ¯”ä¾‹
                
                // ç»˜åˆ¶ä¸»ä½“åœ†å½¢
                ctx.beginPath();
                ctx.arc(drawX, drawY, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${colors.join(',')},${0.5 + energyRatio * 0.5})`; // é€æ˜åº¦éšèƒ½é‡å˜åŒ–
                ctx.fill();

                // ç»˜åˆ¶èƒ½é‡æ¡ï¼ˆç»¿è‰²>50%ï¼Œçº¢è‰²â‰¤50%ï¼‰
                if(showEnergyBars) {
                    ctx.fillStyle = energyRatio > 0.5 ? '#4CAF50' : '#F44336';
                    ctx.fillRect(drawX - 10, drawY + 8, 20 * energyRatio, 3);
                }
            }
        }

        // å¸§è®¡æ•°å™¨ï¼ˆç”¨äºæ§åˆ¶å›¾è¡¨æ›´æ–°é¢‘ç‡ï¼‰
        let frameCount = 0;

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            // è‰ç”Ÿæˆé€»è¾‘
            if(entities.grass.length < config.grass.maxCount && Math.random() < config.grass.spawnRate) {
                const x = Math.random() * canvas.width; // ä¿®æ”¹ä¸º
                const y = Math.random() * canvas.height; // ä¿®æ”¹ä¸º
                entities.grass.push({ x, y });
            }

            // æ›´æ–°æ‰€æœ‰å®ä½“çŠ¶æ€
            updateEntities('sheep');
            updateEntities('wolf');

            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-color');
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶æ‰€æœ‰è‰ï¼ˆç»¿è‰²å°æ–¹å—ï¼‰
            entities.grass.forEach(g => {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--grass-color');
                ctx.fillRect(g.x, g.y, 2, 2);
            });

            // ç»˜åˆ¶æ‰€æœ‰åŠ¨ç‰©
            entities.sheep.forEach(s => s.draw());
            entities.wolf.forEach(w => w.draw());

            // æ¯60å¸§æ›´æ–°ä¸€æ¬¡å›¾è¡¨ï¼ˆçº¦æ¯ç§’æ›´æ–°ï¼‰
            if(frameCount++ % 60 === 0) {
                updateChart();
                // åœ¨gameLoopå‡½æ•°å†…æ·»åŠ 
                if(frameCount % 60 === 0) {
                    console.log('ç¾Šç¾¤çŠ¶æ€ï¼š', 
                        `é€ƒè·‘ä¸­ï¼š${entities.sheep.filter(s => s.isFleeing).length}`,
                        `å¹³å‡èƒ½é‡ï¼š${entities.sheep.reduce((a,b)=>a+b.energy,0)/entities.sheep.length || 0}`
                    );
                }
            }

            requestAnimationFrame(gameLoop); // å¾ªç¯è°ƒç”¨ä¿æŒåŠ¨ç”»æµç•…
        }

        // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
        const chart = new Chart(document.getElementById('populationChart'), {
            type: 'line',
            data: {
                labels: chartData.labels,  // Xè½´æ ‡ç­¾ï¼ˆæ—¶é—´ï¼‰
                datasets: [{
                    label: 'ç¾Š',
                    data: chartData.sheep, // ç¾Šæ•°é‡æ•°æ®é›†
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color'), // ç»¿è‰²çº¿æ¡
                    tension: 0.3          // æ›²çº¿å¹³æ»‘åº¦
                }, {
                    label: 'ç‹¼',
                    data: chartData.wolf,  // ç‹¼æ•°é‡æ•°æ®é›†
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--secondary-color'), // ä¿®æ”¹ç‹¼çš„é¢œè‰²ä¸ºäº®çº¢è‰²
                    tension: 0.3,
                    yAxisID: 'y1'         // å…³è”åˆ°æ–°çš„Yè½´
                }]
            },
            options: {
                responsive: true,        // å“åº”å¼å¸ƒå±€
                maintainAspectRatio: false, // ä¸ä¿æŒçºµæ¨ªæ¯”
                plugins: { 
                    legend: { 
                        position: 'top'  // å›¾ä¾‹æ˜¾ç¤ºåœ¨é¡¶éƒ¨
                    } 
                },
                scales: {
                    y: { 
                        beginAtZero: true, // Yè½´ä»0å¼€å§‹
                        id: 'y',           // é»˜è®¤Yè½´ID
                        position: 'left'   // é»˜è®¤Yè½´ä½ç½®
                    },
                    y1: {                 // æ–°å¢çš„Yè½´é…ç½®
                        beginAtZero: true,
                        id: 'y1',
                        position: 'right',
                        grid: {
                            drawOnChartArea: false // ä¸åœ¨å›¾è¡¨åŒºåŸŸå†…ç»˜åˆ¶ç½‘æ ¼çº¿
                        }
                    },
                    x: { 
                        display: false   // éšè—Xè½´æ ‡ç­¾
                    }
                }
            }
        });

        let shouldPause = false; // æ–°å¢å…¨å±€å˜é‡

        function updateChart() {
            // æ£€æµ‹æ˜¯å¦éœ€è¦æš‚åœè®°å½•
            if(entities.sheep.length === 0 && entities.wolf.length === 0) {
                shouldPause = true;
                return; // åœæ­¢è®°å½•
            } else if(shouldPause) {
                // å½“ç”Ÿç‰©é‡æ–°å‡ºç°æ—¶é‡ç½®æ•°æ®
                chartData = { labels: [], sheep: [], wolf: [] };
                shouldPause = false;
            }
            
            const time = new Date().toLocaleTimeString(); // è·å–å½“å‰æ—¶é—´
            chartData.labels.push(time);          // æ·»åŠ æ—¶é—´æ ‡ç­¾
            chartData.sheep.push(entities.sheep.length); // å½“å‰ç¾Šæ•°é‡
            chartData.wolf.push(entities.wolf.length);   // å½“å‰ç‹¼æ•°é‡ï¼Œç§»é™¤ä¹˜ä»¥20
            
            // é™åˆ¶æ•°æ®ä¸Šé™ä¸ºä¸€ä¸‡
            if (chartData.labels.length > 10000) {
                chartData.labels.shift();
                chartData.sheep.shift();
                chartData.wolf.shift();
            }

            // æ ¹æ®å±•å¼€çŠ¶æ€æ˜¾ç¤ºæ•°æ®
            chart.data.labels = isChartExpanded ? chartData.labels : chartData.labels.slice(-100);
            chart.data.datasets[0].data = isChartExpanded ? chartData.sheep : chartData.sheep.slice(-100);
            chart.data.datasets[1].data = isChartExpanded ? chartData.wolf : chartData.wolf.slice(-100);
            
            chart.update(); // åˆ·æ–°å›¾è¡¨æ˜¾ç¤º

            // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥æ•°æ®å’Œå›¾è¡¨çŠ¶æ€
            console.log('Chart Data:', chartData);
            console.log('Chart Instance:', chart);
        }

        function togglePanel() {
            document.querySelector('.param-panel').classList.toggle('active');
        }

        function toggleChart() {
            const chartContainer = document.getElementById('chartContainer');
            
            // å¦‚æœå½“å‰æ˜¯å±•å¼€çŠ¶æ€ï¼Œå…ˆæ‰§è¡Œæ”¶æ‹¢
            if(isChartExpanded) {
                toggleExpand(); // è¿™ä¼šé‡ç½®isChartExpandedçŠ¶æ€
            }
            
            // åˆ‡æ¢åŸºç¡€æ˜¾ç¤ºçŠ¶æ€ï¼ˆé€šè¿‡CSSç±»æ§åˆ¶ï¼‰
            chartContainer.classList.toggle('active');
            
            // æ”¶æ‹¢åæ¸…é™¤å¯èƒ½æ®‹ç•™çš„å†…è”æ ·å¼
            if(!chartContainer.classList.contains('active')) {
                chartContainer.style.removeProperty('left');
                chartContainer.style.removeProperty('bottom');
                chartContainer.style.removeProperty('width');
            }
        }

        function toggleExpand() {
            const container = document.getElementById('chartContainer');
            isChartExpanded = !isChartExpanded;
            
            container.querySelector('.expand-btn').textContent = isChartExpanded ? 'æ”¶æ‹¢' : 'å±•å¼€';
            
            // å¼ºåˆ¶æ¸…é™¤å¯èƒ½å†²çªçš„å†…è”æ ·å¼
            container.style.removeProperty('left');
            container.style.removeProperty('bottom');
            container.style.removeProperty('width');
            
            if(isChartExpanded) {
                container.classList.add('expanded'); // æ·»åŠ æ‰©å±•çŠ¶æ€æ ‡è®°
                container.style.setProperty('left', '0', 'important');
                container.style.setProperty('bottom', '0', 'important');
                container.style.setProperty('width', '98%', 'important');
            } else {
                container.classList.remove('expanded');
                // ä¿ç•™activeç±»ï¼Œé€šè¿‡CSSç±»æ§åˆ¶å®šä½
            }
        }

        function updateEntities(type) {
            for(let i = entities[type].length-1; i>=0; i--) {
                if(!entities[type][i].update()) {
                    entities[type].splice(i, 1);
                }
            }
        }

        function spawn(type, count) {
            if (type === 'grass') {
                for (let i = 0; i < count; i++) {
                    const x = Math.random() * canvas.width; // ä¿®æ”¹ä¸º
                    const y = Math.random() * canvas.height; // ä¿®æ”¹ä¸º
                    entities.grass.push({ x, y });
                }
            } else {
                for (let i = 0; i < count; i++) {
                    entities[type].push(new Animal(
                        type,
                        Math.random() * canvas.width,
                        Math.random() * canvas.height
                    ));
                }
            }
        }

        function resetWorld() {
            entities = { grass: [], sheep: [], wolf: [] };
            clearChartData(); // æ¸…é™¤å›¾è¡¨æ•°æ®
            for (let i = 0; i < 100; i++) { // ä¿®æ”¹åˆå§‹è‰çš„æ•°é‡ä¸º100
                const x = Math.random() * (canvas.width - 24) + 12; // ç”Ÿæˆåœ¨è¾¹ç•Œå†…12åƒç´ å¤–çš„xåæ ‡
                const y = Math.random() * (canvas.height - 24) + 12; // ç”Ÿæˆåœ¨è¾¹ç•Œå†…12åƒç´ å¤–çš„yåæ ‡
                entities.grass.push({ x, y });
            }
            spawn('sheep', 40); // ä¿®æ”¹åˆå§‹ç¾Šçš„æ•°é‡ä¸º40
            spawn('wolf', 5);
        }

        // æ–°å¢å‡½æ•°ï¼šåˆ é™¤åœºä¸Šæ‰€æœ‰ç”Ÿç‰©
        function clearEntities() {
            entities = { grass: [], sheep: [], wolf: [] };
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', function() {
                document.getElementById(this.id + 'Value').textContent = this.value;
            });
        });

        // æ–°å¢äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('sheepPerception').addEventListener('input', function() {
            document.getElementById('sheepPerceptionValue').textContent = this.value;
        });
        document.getElementById('wolfPerception').addEventListener('input', function() {
            document.getElementById('wolfPerceptionValue').textContent = this.value;
        });

        // åœ¨å…¨å±€æ·»åŠ å±•å¼€çŠ¶æ€æ ‡è®°
        let isChartExpanded = false;

        function clearChartData() {
            chartData = { labels: [], sheep: [], wolf: [] };
            chart.data.labels = [];
            chart.data.datasets.forEach(dataset => dataset.data = []);
            chart.update();
        }

        // ä¸»é¢˜é…ç½®å¯¹è±¡
        const themes = {
            default: {},
            dark: {},
            tech: {},
            warm: {}
        };

        function changeTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            
            // æ›´æ–°å›¾è¡¨é¢œè‰²
            chart.data.datasets[0].borderColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--primary-color');
            chart.data.datasets[1].borderColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--secondary-color');
            chart.update();
            
            // å¼ºåˆ¶é‡ç»˜æ‰€æœ‰åŠ¨ç‰©
            entities.sheep.forEach(s => s.draw());
            entities.wolf.forEach(w => w.draw());
        }

        let showEnergyBars = false; // ä¿®æ”¹é»˜è®¤çŠ¶æ€ä¸ºéšè—

        // æ·»åŠ åˆ‡æ¢å‡½æ•°
        function toggleEnergyBars() {
            showEnergyBars = !showEnergyBars;
            const btn = document.querySelector('button[onclick="toggleEnergyBars()"]');
            btn.textContent = showEnergyBars ? 'éšè—èƒ½é‡æ¡' : 'æ˜¾ç¤ºèƒ½é‡æ¡';
        }

        document.querySelector('button[onclick="toggleEnergyBars()"]').textContent = 
            showEnergyBars ? 'éšè—èƒ½é‡æ¡' : 'æ˜¾ç¤ºèƒ½é‡æ¡';

        // ä¿®æ”¹åçš„æŠ˜å æ§åˆ¶å‡½æ•°
        function toggleGroup(groupId) {
            const groupContent = document.getElementById(groupId + 'Group');
            const toggleBtn = groupContent.previousElementSibling.querySelector('.toggle-btn');
            
            // æ·»åŠ å±•å¼€çŠ¶æ€ç±»
            groupContent.classList.toggle('expanded');
            
            if (groupContent.classList.contains('expanded')) {
                // å±•å¼€æ—¶è®¾ç½®ç²¾ç¡®é«˜åº¦
                groupContent.style.maxHeight = groupContent.scrollHeight + 'px';
                toggleBtn.textContent = 'â–²';
            } else {
                // æŠ˜å æ—¶é‡ç½®é«˜åº¦å¹¶æ·»åŠ è¿‡æ¸¡
                groupContent.style.maxHeight = '0';
                toggleBtn.textContent = 'â–¼';
            }
        }

        // åˆå§‹åŒ–ä»£ç éœ€è¦æ·»åŠ ï¼ˆæ”¾åœ¨é¡µé¢åŠ è½½äº‹ä»¶ä¸­ï¼‰ï¼š
        window.addEventListener('load', () => {
            document.querySelectorAll('.group-content').forEach(group => {
                group.style.maxHeight = '0'; // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸ºæŠ˜å 
                group.classList.remove('expanded'); // ç§»é™¤å±•å¼€çŠ¶æ€
            });
        });

        // åŒæ­¥æ»‘åŠ¨æ¡å’Œæ•°å­—è¾“å…¥æ¡†
        document.querySelectorAll('input[type="range"]').forEach(range => {
            const numberInput = range.nextElementSibling;
            
            // ç§»é™¤è¾“å…¥æ¡†çš„æ‰€æœ‰é™åˆ¶å±æ€§
            numberInput.removeAttribute('min');
            numberInput.removeAttribute('max');
            numberInput.removeAttribute('step');

            range.addEventListener('input', function() {
                // ç›´æ¥åŒæ­¥æ•°å€¼ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
                numberInput.value = this.value;
                document.getElementById(this.id + 'Value').textContent = this.value;
            });

            numberInput.addEventListener('change', function() {
                // ç›´æ¥ä¼ é€’åŸå§‹å€¼
                const value = parseFloat(this.value) || 0;
                
                // æ›´æ–°æ»‘åŠ¨æ¡å€¼ï¼ˆå³ä½¿è¶…å‡ºåŸå§‹èŒƒå›´ï¼‰
                range.value = value;
                
                // æ›´æ–°æ˜¾ç¤ºå€¼
                document.getElementById(range.id + 'Value').textContent = value;
                
                // å¼ºåˆ¶æ›´æ–°é…ç½®
                range.dispatchEvent(new Event('input'));
            });
        });

        resetWorld();
        gameLoop();
    </script>
</body>
</html>